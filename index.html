<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Top Descontos e Oportunidades</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    :root{--accent:#f59e0b}
    body{background:#f8fafc}
    .card { transition: transform .18s ease, box-shadow .18s ease; border-radius:12px; overflow:hidden; }
    .card:hover{ transform: translateY(-8px); box-shadow:0 12px 30px rgba(2,6,23,.08); }
    /* Destaques horizontais compactos */
    .destaque-row { display:flex; gap:0.6rem; overflow-x:auto; padding-bottom:6px; }
    .destaque-row::-webkit-scrollbar{display:none}
    .destaque-card{ flex:0 0 150px; min-width:150px }
    /* Carousel auto (simple) */
    #carouselTrack { display:flex; gap:0.6rem; transition: transform .3s ease; }
    /* Small helpers */
    .badge-discount{ background:linear-gradient(90deg,#ef4444,#fb7185); color:white; padding:4px 7px; border-radius:999px; font-weight:700; font-size:12px; }
  </style>
</head>
<body class="font-sans text-gray-800">

  <!-- HEADER -->
  <header class="bg-white shadow sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <img src="./logox.png" alt="Top Descontos e Oportunidades" class="h-12 object-contain" id="logoImg"/>
        <div>
          <div id="siteTitle" class="text-xl font-extrabold">Top Descontos e Oportunidades</div>
          <div id="siteSubtitle" class="text-xs text-gray-500">Ofertas atualizadas automaticamente</div>
        </div>
      </div>

      <div class="flex-1 max-w-2xl px-4">
        <div class="flex gap-3">
          <input id="search" type="search" placeholder="Pesquisar produtos..." class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-yellow-200" />
          <select id="categoryFilter" class="border rounded-lg px-3 py-2">
            <option value="">Todas as categorias</option>
          </select>
          <select id="langSelect" class="border rounded-lg px-3 py-2">
            <option value="pt">ðŸ‡µðŸ‡¹ PT</option>
            <option value="es">ðŸ‡ªðŸ‡¸ ES</option>
          </select>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <a id="ctaAmazon" href="#" class="px-3 py-2 bg-yellow-500 text-white rounded-lg">Visitar</a>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="max-w-7xl mx-auto px-4 py-8">

    <!-- DESTAQUES COMPACTOS (carrossel horizontal) -->
    <section class="mb-6">
      <div class="flex items-center justify-between mb-3">
        <h2 id="headingDestaques" class="text-lg font-semibold">Destaques</h2>
        <div id="destaqueCount" class="text-sm text-gray-500"></div>
      </div>
      <div id="destaqueRow" class="destaque-row"></div>
    </section>

    <!-- STATS -->
    <section class="mb-4">
      <div id="stats" class="text-sm text-gray-600">â€”</div>
    </section>

    <!-- GRID -->
    <section id="grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></section>

    <!-- PAGINAÃ‡ÃƒO -->
    <div class="mt-8 flex justify-center items-center gap-2">
      <button id="prevBtn" class="px-3 py-1 bg-white border rounded">Â«</button>
      <div id="pageInfo" class="text-sm text-gray-700"></div>
      <button id="nextBtn" class="px-3 py-1 bg-white border rounded">Â»</button>
    </div>

  </main>

  <footer class="text-center text-sm text-gray-500 py-8">Â© <span id="year"></span> Top Descontos e Oportunidades</footer>

<script>
/* ---------- CONFIG ---------- */
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzX7nYrpzC9QEXk-rMxzu6WTPG0Ox9tKj33v-mwWI6vC0gxcXki7k_uhs7dc4LvdCrs6Q/exec';
const PAGE_SIZE = 12;
const LANG_KEY = 'shop_lang';

/* ---------- TRANSLATIONS ---------- */
const T = {
  pt: {
    searchPlaceholder: 'Pesquisar produtos...',
    destaques: 'Destaques',
    productsFound: 'Produtos encontrados:',
    viewOffer: 'Ver oferta',
    visit: 'Visitar',
    noProducts: 'Nenhum produto encontrado.'
  },
  es: {
    searchPlaceholder: 'Buscar productos...',
    destaques: 'Destacados',
    productsFound: 'Productos encontrados:',
    viewOffer: 'Ver oferta',
    visit: 'Visitar',
    noProducts: 'No se encontraron productos.'
  }
};

/* ---------- STATE ---------- */
let PRODUCTS = [];
let currentPage = 1;
let lang = localStorage.getItem(LANG_KEY) || (navigator.language && navigator.language.startsWith('es') ? 'es' : 'pt');

/* ---------- HELPERS ---------- */
function toNumber(v){
  if(v === undefined || v === null || v === '') return null;
  const s = String(v).replace(',', '.').replace(/[^0-9.\-]/g, '');
  const n = parseFloat(s);
  return isNaN(n) ? null : n;
}
function fmtEUR(n){ return n != null ? 'â‚¬' + Number(n).toFixed(2) : ''; }
function esc(s){ return s ? String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])) : ''; }

/* ---------- RENDER CARDS ---------- */
function renderDestaqueCard(p){
  // compact small card
  const preco = toNumber(p['preÃ§o']);
  const promo = toNumber(p['promoÃ§Ã£o']);
  const isPromo = promo && preco && promo < preco;
  const discount = isPromo ? Math.round((1 - promo / preco) * 100) : 0;
  const img = p['imagem'] || 'https://via.placeholder.com/300x200?text=Sem+imagem';
  const link = p['link'] || '#';
  const title = p['tÃ­tulo'] || '';
  return `
    <article class="bg-white rounded-lg p-2 text-xs destaque-card card">
      <div class="relative overflow-hidden rounded-md">
        <img src="${esc(img)}" alt="${esc(title)}" class="w-full h-24 object-cover"/>
        ${isPromo ? `<span class="badge-discount absolute left-2 top-2 text-xs">-${discount}%</span>` : ''}
      </div>
      <h4 class="mt-1 font-semibold text-xs line-clamp-2">${esc(title)}</h4>
      <div class="mt-1 text-xs">
        ${isPromo ? `<div class="line-through text-gray-400 text-xs">${fmtEUR(preco)}</div><div class="font-bold text-xs">${fmtEUR(promo)}</div>` : `<div class="font-bold text-xs">${fmtEUR(preco)}</div>`}
      </div>
      <a class="inline-block mt-1 px-1 py-0.5 bg-yellow-400 rounded text-xs" href="${esc(link)}" target="_blank" rel="noopener noreferrer">${T[lang].viewOffer}</a>
    </article>
  `;
}

function renderGridCard(p){
  const preco = toNumber(p['preÃ§o']);
  const promo = toNumber(p['promoÃ§Ã£o']);
  const isPromo = promo && preco && promo < preco;
  const discount = isPromo ? Math.round((1 - promo / preco) * 100) : 0;
  const img = p['imagem'] || 'https://via.placeholder.com/400x300?text=Sem+imagem';
  const link = p['link'] || '#';
  const title = p['tÃ­tulo'] || '';
  return `
    <article class="bg-white rounded-2xl p-4 card flex flex-col">
      <div class="relative overflow-hidden rounded-lg">
        <img src="${esc(img)}" alt="${esc(title)}" class="w-full h-44 object-cover"/>
        ${isPromo ? `<span class="badge-discount absolute left-3 top-3">${'-' + discount + '%'}</span>` : ''}
      </div>
      <h3 class="mt-3 text-sm font-semibold">${esc(title)}</h3>
      <div class="mt-3 flex items-center justify-between">
        <div>
          ${isPromo ? `<div class="text-sm text-gray-500 line-through">${fmtEUR(preco)}</div><div class="text-lg font-bold">${fmtEUR(promo)}</div>` : `<div class="text-lg font-bold">${fmtEUR(preco)}</div>`}
        </div>
        <a class="ml-2 mt-auto inline-block px-3 py-2 bg-yellow-500 rounded-md text-sm font-semibold" href="${esc(link)}" target="_blank" rel="noopener noreferrer">${T[lang].viewOffer}</a>
      </div>
    </article>
  `;
}

/* ---------- RENDER LAYOUT ---------- */
function updateTranslations(){
  // set placeholders and headings
  document.getElementById('search').placeholder = T[lang].searchPlaceholder;
  document.getElementById('headingDestaques').textContent = T[lang].destaques;
  document.getElementById('ctaAmazon').textContent = T[lang].visit;
  // page title / subtitle
  document.getElementById('siteTitle').textContent = 'Top Descontos e Oportunidades';
  document.getElementById('siteSubtitle').textContent = (lang === 'es' ? 'Ofertas actualizadas automÃ¡ticamente' : 'Ofertas atualizadas automaticamente');
  // re-render visible content (so button texts update)
  renderPage();
  renderDestaques();
}

/* ---------- DATA + PAGINATION ---------- */
function populateCategories(){
  const sel = document.getElementById('categoryFilter');
  // clear extras
  sel.querySelectorAll('option:not(:first-child)').forEach(o=>o.remove());
  const cats = new Set();
  PRODUCTS.forEach(p => { if(p['categoria']) cats.add(p['categoria'].trim()); });
  Array.from(cats).sort().forEach(c=>{
    const o = document.createElement('option'); o.value = c; o.textContent = c; sel.appendChild(o);
  });
}

function renderDestaques(){
  const container = document.getElementById('destaqueRow');
  const destaques = PRODUCTS.filter(p=> p['destaque'] && String(p['destaque']).toLowerCase()==='sim');
  container.innerHTML = destaques.length ? destaques.map(renderDestaqueCard).join('') : `<div class="text-sm text-gray-500">${lang==='es' ? 'Sin destacados' : 'Sem destaques'}</div>`;
  document.getElementById('destaqueCount').textContent = destaques.length ? `${destaques.length} ${lang==='es'?'items':'itens'}` : '';
}

function renderPage(){
  const q = document.getElementById('search').value.trim().toLowerCase();
  const cat = document.getElementById('categoryFilter').value;
  let filtered = PRODUCTS.filter(p => {
    const inCat = !cat || (p['categoria'] && p['categoria'].toLowerCase() === cat.toLowerCase());
    const inQ = !q || (p['tÃ­tulo'] && p['tÃ­tulo'].toLowerCase().includes(q));
    // exclude destaque items from main grid
    const isD = p['destaque'] && String(p['destaque']).toLowerCase()==='sim';
    return inCat && inQ && !isD;
  });

  // sort: promos first
  filtered.sort((a,b)=>{
    const aPromo = toNumber(a['promoÃ§Ã£o']) || null;
    const aPrice = toNumber(a['preÃ§o']) || 0;
    const bPromo = toNumber(b['promoÃ§Ã£o']) || null;
    const bPrice = toNumber(b['preÃ§o']) || 0;
    const aIs = (aPromo && aPromo < aPrice) ? 1 : 0;
    const bIs = (bPromo && bPromo < bPrice) ? 1 : 0;
    return bIs - aIs;
  });

  const total = filtered.length;
  document.getElementById('stats').textContent = `${T[lang].productsFound} ${total}`;

  const pages = Math.max(1, Math.ceil(total / PAGE_SIZE));
  currentPage = Math.min(currentPage, pages);
  const start = (currentPage - 1) * PAGE_SIZE;
  const pageItems = filtered.slice(start, start + PAGE_SIZE);

  document.getElementById('grid').innerHTML = pageItems.length ? pageItems.map(renderGridCard).join('') : `<div class="text-gray-500">${T[lang].noProducts}</div>`;
  document.getElementById('pageInfo').textContent = `${currentPage} / ${pages}`;
  document.getElementById('prevBtn').disabled = currentPage === 1;
  document.getElementById('nextBtn').disabled = currentPage === pages;
}

/* ---------- EVENTS ---------- */
document.getElementById('prevBtn').addEventListener('click', ()=>{ if(currentPage>1){ currentPage--; renderPage(); }});
document.getElementById('nextBtn').addEventListener('click', ()=>{ currentPage++; renderPage(); });
document.getElementById('search').addEventListener('input', ()=>{ currentPage=1; renderPage(); });
document.getElementById('categoryFilter').addEventListener('change', ()=>{ currentPage=1; renderPage(); });
document.getElementById('langSelect').addEventListener('change', (e)=>{
  lang = e.target.value;
  localStorage.setItem(LANG_KEY, lang);
  updateTranslations();
});

/* ---------- LOAD PRODUCTS ---------- */
async function loadProducts(){
  try{
    // force no-cache param
    const res = await fetch(WEB_APP_URL + '?_=' + Date.now());
    const data = await res.json();
    // Expected columns in the sheet exactly: tÃ­tulo, imagem, preÃ§o, promoÃ§Ã£o, link, categoria, destaque
    PRODUCTS = (data || []).map(r => ({
      'tÃ­tulo': r['tÃ­tulo'] || r['title'] || '',
      'imagem': r['imagem'] || r['image'] || '',
      'preÃ§o': r['preÃ§o'] || r['price'] || '',
      'promoÃ§Ã£o': r['promoÃ§Ã£o'] || r['promo_price'] || r['promocao'] || '',
      'link': r['link'] || r['affiliate_link'] || '',
      'categoria': r['categoria'] || r['category'] || '',
      'destaque': r['destaque'] || ''
    }));
    populateCategories();
    updateTranslations(); // will call renderPage() and renderDestaques()
    document.getElementById('year').textContent = new Date().getFullYear();
    // set language selector UI
    document.getElementById('langSelect').value = lang;
  }catch(err){
    console.error('Erro ao carregar WebApp:', err);
    document.getElementById('grid').innerHTML = `<div class="text-red-500">Erro ao carregar produtos â€” verifica o Web App.</div>`;
  }
}

/* ---------- Auto-scroll pequenos destaques (opcional) ---------- */
let autoScrollTimer = null;
function startAutoScrollDestaques(){
  const row = document.getElementById('destaqueRow');
  if(!row) return;
  stopAutoScrollDestaques();
  autoScrollTimer = setInterval(()=>{
    if(row.scrollWidth <= row.clientWidth) return;
    row.scrollBy({left: row.clientWidth * 0.6, behavior: 'smooth'});
    // loop back
    if(row.scrollLeft + row.clientWidth >= row.scrollWidth - 10) row.scrollTo({left:0, behavior:'smooth'});
  }, 4200);
}
function stopAutoScrollDestaques(){ if(autoScrollTimer) clearInterval(autoScrollTimer); autoScrollTimer = null; }
document.getElementById('destaqueRow').addEventListener('mouseenter', stopAutoScrollDestaques);
document.getElementById('destaqueRow').addEventListener('mouseleave', startAutoScrollDestaques);

/* ---------- Init ---------- */
loadProducts().then(()=> startAutoScrollDestaques());

</script>
</body>
</html>