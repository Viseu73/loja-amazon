<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Loja - Afiliados Amazon</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .product-card { transition: transform .12s ease, box-shadow .12s ease; }
    .product-card:hover { transform: translateY(-6px); box-shadow: 0 8px 28px rgba(0,0,0,.12); }
    .destaque-card { transition: transform .12s ease, box-shadow .12s ease; min-width:150px; flex: 0 0 auto; }
    .destaque-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,.08); }
    .destaque-container { display: flex; overflow-x: auto; gap:0.5rem; padding-bottom:0.5rem; }
    .destaque-container::-webkit-scrollbar { display: none; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">

<header class="bg-white shadow-md">
  <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
    <img src="logotipo.png" alt="Logo" class="h-12"/>
    <div class="space-x-3">
      <input id="search" placeholder="Pesquisar produtos..." class="px-3 py-2 border rounded-md" />
      <select id="categoryFilter" class="px-3 py-2 border rounded-md">
        <option value="">Todas as categorias</option>
      </select>
      <select id="sortSelect" class="px-3 py-2 border rounded-md">
        <option value="relevance">Mais relevantes</option>
        <option value="price_asc">Preço ↑</option>
        <option value="price_desc">Preço ↓</option>
        <option value="promo_desc">Desconto ↓</option>
      </select>
    </div>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 py-8">
  <!-- Destaques em carrossel -->
  <section id="destaque" class="mb-6">
    <h2 class="text-lg font-semibold mb-3">Destaques</h2>
    <div class="destaque-container"></div>
  </section>

  <!-- Grid normal -->
  <section id="stats" class="mb-6 text-sm text-gray-600"></section>
  <section id="grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></section>
  <nav id="pagination" class="mt-8 flex justify-center"></nav>
</main>

<footer class="text-center text-sm text-gray-500 py-6">Gerado com ❤️ — Template de catálogo usando Google Sheets</footer>

<script>
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzX7nYrpzC9QEXk-rMxzu6WTPG0Ox9tKj33v-mwWI6vC0gxcXki7k_uhs7dc4LvdCrs6Q/exec';
const PAGE_SIZE = 24;
let PRODUCTS = [];
let currentPage = 1;

function toNumber(v){
  if(!v) return null;
  const s=String(v).replace(',', '.').replace(/[^0-9.\-]/g,'');
  const n=parseFloat(s);
  return isNaN(n)? null : n;
}

function escapeHtml(str){ if(!str) return ''; return String(str).replace(/[&<>"']/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[s])); }

function renderCard(p){
  const price = toNumber(p.preço) != null ? `€${toNumber(p.preço).toFixed(2)}` : '—';
  const promo = toNumber(p.promocao) != null && toNumber(p.promocao) < toNumber(p.preço) ? `€${toNumber(p.promocao).toFixed(2)}` : null;
  const discount = promo ? Math.round((1 - toNumber(p.promocao)/toNumber(p.preço))*100) : 0;
  const img = p.imagem || 'https://via.placeholder.com/400x300?text=Sem+imagem';
  const link = p.link || '#';
  return `
    <article class="bg-white rounded-2xl p-4 product-card">
      <div class="relative overflow-hidden rounded-lg">
        <img loading="lazy" src="${img}" alt="${escapeHtml(p.título)}" class="w-full h-48 object-cover"/>
        ${discount? `<div class="absolute top-2 left-2 bg-red-500 text-white px-2 py-1 rounded-md text-xs font-bold">-${discount}%</div>`:''}
      </div>
      <h3 class="mt-3 text-sm font-semibold leading-tight">${escapeHtml(p.título)}</h3>
      <div class="mt-3 flex items-center justify-between">
        <div>${promo? `<div class="text-sm text-gray-500 line-through">${price}</div><div class="text-lg font-bold">${promo}</div>`:`<div class="text-lg font-bold">${price}</div>`}</div>
        <a href="${link}" target="_blank" rel="noopener noreferrer" class="px-3 py-2 bg-yellow-500 rounded-md text-sm font-semibold">Ver oferta</a>
      </div>
    </article>
  `;
}

function renderCardDestaque(p){
  const price = toNumber(p.preço) != null ? `€${toNumber(p.preço).toFixed(2)}` : '—';
  const promo = toNumber(p.promocao) != null && toNumber(p.promocao) < toNumber(p.preço) ? `€${toNumber(p.promocao).toFixed(2)}` : null;
  const discount = promo ? Math.round((1 - toNumber(p.promocao)/toNumber(p.preço))*100) : 0;
  const img = p.imagem || 'https://via.placeholder.com/300x200?text=Sem+imagem';
  const link = p.link || '#';
  return `
    <article class="bg-white rounded-lg p-2 text-xs destaque-card">
      <div class="relative overflow-hidden rounded-md">
        <img loading="lazy" src="${img}" alt="${escapeHtml(p.título)}" class="w-full h-24 object-cover"/>
        ${discount? `<div class="absolute top-1 left-1 bg-red-500 text-white px-1 py-0.5 rounded-md text-xs font-bold">-${discount}%</div>`:''}
      </div>
      <h3 class="mt-1 font-semibold text-xs">${escapeHtml(p.título)}</h3>
      <div class="mt-1">${promo? `<div class="text-gray-500 line-through text-xs">${price}</div><div class="font-bold text-xs">${promo}</div>`:`<div class="font-bold text-xs">${price}</div>`}</div>
      <a href="${link}" target="_blank" class="mt-1 inline-block px-1 py-0.5 bg-yellow-400 text-xs rounded">Ver oferta</a>
    </article>
  `;
}

function renderStats(total){ document.getElementById('stats').textContent=`Produtos encontrados: ${total}`; }

function renderPagination(totalItems){
  const pages = Math.max(1, Math.ceil(totalItems / PAGE_SIZE));
  const nav = document.getElementById('pagination');
  let html='';
  const start=Math.max(1,currentPage-2);
  const end=Math.min(pages,currentPage+2);
  if(currentPage>1) html+=`<button onclick="gotoPage(${currentPage-1})" class="px-3 py-1 mx-1 bg-white border rounded">«</button>`;
  for(let i=start;i<=end;i++) html+=`<button onclick="gotoPage(${i})" class="px-3 py-1 mx-1 ${i===currentPage?'bg-yellow-400 text-white rounded':'bg-white border rounded'}">${i}</button>`;
  if(currentPage<pages) html+=`<button onclick="gotoPage(${currentPage+1})" class="px-3 py-1 mx-1 bg-white border rounded">»</button>`;
  nav.innerHTML=html;
}

function gotoPage(n){ currentPage=n; applyFiltersAndRender(); }

function applyFiltersAndRender(){
  const q=document.getElementById('search').value.trim().toLowerCase();
  const cat=document.getElementById('categoryFilter').value;
  let filtered=PRODUCTS.filter(p=>{
    const inCat=!cat || (p.categoria && p.categoria.toLowerCase()===cat.toLowerCase());
    const inQ=!q || (p.título && p.título.toLowerCase().includes(q));
    return inCat && inQ && (!p.destaque || p.destaque.toLowerCase()!=='sim');
  });
  const sort=document.getElementById('sortSelect').value;
  if(sort==='price_asc') filtered.sort((a,b)=> (toNumber(a.promocao)||toNumber(a.preço)||0) - (toNumber(b.promocao)||toNumber(b.preço)||0));
  if(sort==='price_desc') filtered.sort((a,b)=> (toNumber(b.promocao)||toNumber(b.preço)||0) - (toNumber(a.promocao)||toNumber(a.preço)||0));
  if(sort==='promo_desc') filtered.sort((a,b)=> ((toNumber(a.preço)-(toNumber(a.promocao)||toNumber(a.preço)))||0)-((toNumber(b.preço)-(toNumber(b.promocao)||toNumber(b.preço)))||0)).reverse();
  const total=filtered.length;
  renderStats(total);
  renderPagination(total);
  const start=(currentPage-1)*PAGE_SIZE;
  const pageItems=filtered.slice(start,start+PAGE_SIZE);
  document.getElementById('grid').innerHTML=pageItems.map(renderCard).join('\n');
}

function renderDestaques(){
  const container=document.querySelector('.destaque-container');
  const destaques=PRODUCTS.filter(p=>p.destaque && p.destaque.toLowerCase()==='sim');
  container.innerHTML=destaques.map(renderCardDestaque).join('\n');
}

async function loadProducts(){
  try{
    const res=await fetch(WEB_APP_URL);
    const data=await res.json();
    PRODUCTS=data.map(p=>({
      título:p.título||'',
      imagem:p.imagem||'',
      preço:p.preço||'',
      promocao:p.promocao||'',
      link:p.link||'#',
      categoria:p.categoria||'',
      destaque:p.destaque||''
    }));
    populateCategories();
    renderDestaques();
    applyFiltersAndRender();
  }catch(e){
    console.error(e);
    alert('Erro ao carregar os produtos. Verifica o Web App do Google Sheets.');
  }
}

function populateCategories(){
  const set=new Set();
  PRODUCTS.forEach(p=>{ if(p.categoria) set.add(p.categoria.trim()); });
  const sel=document.getElementById('categoryFilter');
  set.forEach(c=>{ const opt=document.createElement('option'); opt.value=c; opt.textContent=c; sel.appendChild(opt); });
}

document.getElementById('search').addEventListener('input',()=>{currentPage=1; applyFiltersAndRender();});
document.getElementById('categoryFilter').addEventListener('change',()=>{currentPage=1; applyFiltersAndRender();});
document.getElementById('sortSelect').addEventListener('change',()=>{currentPage=1; applyFiltersAndRender();});

loadProducts();
</script>
</body>
</html>
