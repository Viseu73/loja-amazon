<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Top Descontos e Oportunidades</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .product-card { transition: transform .12s ease, box-shadow .12s ease; }
    .product-card:hover { transform: translateY(-6px); box-shadow: 0 8px 28px rgba(0,0,0,.12); }
    .destaque { transform: scale(0.85); border: 2px solid #facc15; }
    .header-logo { max-height: 60px; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">

<header class="bg-white shadow-md">
  <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
    <div class="flex items-center space-x-3">
      <img src="logox.png" alt="Logo" class="header-logo">
      <h1 class="text-2xl font-semibold">Top Descontos e Oportunidades</h1>
    </div>
    <div class="space-x-3">
      <input id="search" placeholder="Pesquisar produtos..." class="px-3 py-2 border rounded-md" />
      <select id="categoryFilter" class="px-3 py-2 border rounded-md">
        <option value="">Todas as categorias</option>
      </select>
      <select id="sortSelect" class="px-3 py-2 border rounded-md">
        <option value="relevance">Mais relevantes</option>
        <option value="price_asc">Preço ↑</option>
        <option value="price_desc">Preço ↓</option>
        <option value="promo_desc">Desconto ↓</option>
      </select>
    </div>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 py-8">
  <section id="stats" class="mb-6 text-sm text-gray-600"></section>
  <section id="grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></section>
  <nav id="pagination" class="mt-8 flex justify-center"></nav>
</main>

<footer class="text-center text-sm text-gray-500 py-6">Gerado com ❤️ — Template de catálogo usando Google Sheets</footer>

<script>
// ---------------- CONFIG ----------------
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzX7nYrpzC9QEXk-rMxzu6WTPG0Ox9tKj33v-mwWI6vC0gxcXki7k_uhs7dc4LvdCrs6Q/exec';
const PAGE_SIZE = 24;

let PRODUCTS = [];
let currentPage = 1;

// ---------------- UTIL ----------------
function fetchProducts() {
  return fetch(WEB_APP_URL).then(res => res.json());
}

function toNumber(v) {
  if (!v) return null;
  const s = String(v).replace(',', '.').replace(/[^0-9.\-]/g, '');
  const n = parseFloat(s);
  return isNaN(n) ? null : n;
}

function renderCard(p) {
  const price = p.preco != null ? `€${p.preco.toFixed(2)}` : '—';
  const promo = (p.promocao != null && p.promocao < p.preco) ? `€${p.promocao.toFixed(2)}` : null;
  const discount = (p.promocao != null && p.promocao < p.preco) ? Math.round((1 - p.promocao / p.preco) * 100) : 0;
  const img = p.imagem || 'https://via.placeholder.com/400x300?text=Sem+imagem';
  const link = p.link || '#';
  const destaqueClass = p.destaque.toLowerCase() === 'sim' ? 'destaque' : '';
  return `
    <article class="bg-white rounded-2xl p-4 product-card ${destaqueClass}">
      <div class="relative overflow-hidden rounded-lg">
        <img loading="lazy" src="${img}" alt="${p.titulo}" class="w-full h-48 object-cover" />
        ${promo ? `<div class="absolute top-2 left-2 bg-red-500 text-white px-2 py-1 rounded-md text-xs font-bold">-${discount}%</div>` : ''}
      </div>
      <h3 class="mt-3 text-sm font-semibold leading-tight">${p.titulo}</h3>
      <div class="mt-3 flex items-center justify-between">
        <div>
          ${promo ? `<div class="text-sm text-gray-500 line-through">${price}</div><div class="text-lg font-bold">${promo}</div>` : `<div class="text-lg font-bold">${price}</div>`}
        </div>
        <div>
          <a href="${link}" target="_blank" rel="noopener noreferrer" class="px-3 py-2 bg-yellow-500 rounded-md text-sm font-semibold">Ver oferta</a>
        </div>
      </div>
    </article>
  `;
}

function renderGrid(list) {
  const grid = document.getElementById('grid');
  grid.innerHTML = list.map(renderCard).join('\n');
}

function renderStats(total) {
  const s = document.getElementById('stats');
  s.textContent = `Produtos encontrados: ${total}`;
}

function renderPagination(totalItems) {
  const pages = Math.max(1, Math.ceil(totalItems / PAGE_SIZE));
  const nav = document.getElementById('pagination');
  let html = '';
  const start = Math.max(1, currentPage - 2);
  const end = Math.min(pages, currentPage + 2);
  if (currentPage > 1) html += `<button onclick="gotoPage(${currentPage-1})" class="px-3 py-1 mx-1 bg-white border rounded">«</button>`;
  for (let i = start; i <= end; i++) {
    html += `<button onclick="gotoPage(${i})" class="px-3 py-1 mx-1 ${i===currentPage? 'bg-yellow-400 text-white rounded':'bg-white border rounded'}">${i}</button>`;
  }
  if (currentPage < pages) html += `<button onclick="gotoPage(${currentPage+1})" class="px-3 py-1 mx-1 bg-white border rounded">»</button>`;
  nav.innerHTML = html;
}

function gotoPage(n) {
  currentPage = n;
  applyFiltersAndRender();
}

function applyFiltersAndRender() {
  const q = document.getElementById('search').value.trim().toLowerCase();
  const cat = document.getElementById('categoryFilter').value;
  const sort = document.getElementById('sortSelect').value;

  let filtered = PRODUCTS.filter(p => {
    const inCat = !cat || (p.categoria && p.categoria.toLowerCase() === cat.toLowerCase());
    const inQ = !q || (p.titulo && p.titulo.toLowerCase().includes(q));
    return inCat && inQ;
  });

  if (sort === 'price_asc') filtered.sort((a,b)=> (a.promocao || a.preco || 0) - (b.promocao || b.preco || 0));
  if (sort === 'price_desc') filtered.sort((a,b)=> (b.promocao || b.preco || 0) - (a.promocao || a.preco || 0));
  if (sort === 'promo_desc') filtered.sort((a,b)=> ((a.preco-(a.promocao||a.preco))||0) - ((b.preco-(b.promocao||b.preco))||0)).reverse();

  renderStats(filtered.length);
  renderPagination(filtered.length);

  const start = (currentPage-1)*PAGE_SIZE;
  const pageItems = filtered.slice(start, start+PAGE_SIZE);
  renderGrid(pageItems);
}

function populateCategories() {
  const set = new Set();
  PRODUCTS.forEach(p=>{ if(p.categoria) set.add(p.categoria.trim()); });
  const sel = document.getElementById('categoryFilter');
  set.forEach(c=>{ const opt=document.createElement('option'); opt.value=c; opt.textContent=c; sel.appendChild(opt); });
}

// ---------------- INIT ----------------
async function init() {
  try {
    const data = await fetchProducts();
    PRODUCTS = data.map(p=>({
      titulo: p.titulo || '',
      imagem: p.imagem || '',
      preco: toNumber(p.preco),
      promocao: toNumber(p.promocao),
      link: p.link || '',
      categoria: p.categoria || '',
      destaque: p.destaque || ''
    }));
    populateCategories();
    applyFiltersAndRender();
  } catch(e){
    console.error('Erro ao carregar produtos', e);
    alert('Erro ao carregar produtos. Confirme se o Web App está publicado e acessível.');
  }
}

document.getElementById('search').addEventListener('input',()=>{ currentPage=1; applyFiltersAndRender(); });
document.getElementById('categoryFilter').addEventListener('change',()=>{ currentPage=1; applyFiltersAndRender(); });
document.getElementById('sortSelect').addEventListener('change',()=>{ currentPage=1; applyFiltersAndRender(); });

init();
</script>

</body>
</html>
